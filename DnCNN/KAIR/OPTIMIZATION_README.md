# å°åŒ—101å½±åƒå»å™ª - æ€§èƒ½å„ªåŒ–ç‰ˆæœ¬

## æ¦‚è¿°

é€™æ˜¯ `taipei101_denoise.py` çš„é«˜æ€§èƒ½å„ªåŒ–ç‰ˆæœ¬ï¼Œé€šéå¤šé …æŠ€è¡“æ”¹é€²é¡¯è‘—æå‡äº†å½±åƒè™•ç†çš„æ•ˆç‡å’Œé€Ÿåº¦ã€‚

## ä¸»è¦å„ªåŒ–ç‰¹æ€§

### ğŸš€ æ€§èƒ½å„ªåŒ–
- **æ‰¹é‡è™•ç†**: æ”¯æ´å¤šå¼µå½±åƒåŒæ™‚è™•ç†ï¼Œæ¸›å°‘GPUè¨˜æ†¶é«”å‚³è¼¸é–‹éŠ·
- **æ··åˆç²¾åº¦**: ä½¿ç”¨åŠç²¾åº¦æµ®é»æ•¸(FP16)åŠ é€Ÿæ¨ç†ï¼Œç¯€çœè¨˜æ†¶é«”
- **è¨˜æ†¶é«”ç®¡ç†**: æ™ºèƒ½è¨˜æ†¶é«”åˆ†é…å’ŒåŠæ™‚é‡‹æ”¾ï¼Œé¿å…OOMéŒ¯èª¤
- **ä¸¦è¡ŒI/O**: å¤šç·šç¨‹åœ–åƒè®€å–å’Œä¿å­˜ï¼Œæå‡I/Oæ•ˆç‡
- **æ¨¡å‹ç·¨è­¯**: JITç·¨è­¯å„ªåŒ–æ¨¡å‹åŸ·è¡Œæ•ˆç‡

### ğŸ’¡ ç®—æ³•å„ªåŒ–
- **å¯åˆ†é›¢æ¿¾æ³¢**: ä½¿ç”¨å¯åˆ†é›¢å·ç©æ ¸åŠ é€Ÿå±€éƒ¨çµ±è¨ˆè¨ˆç®—
- **å‘é‡åŒ–æ“ä½œ**: æ‰¹é‡è™•ç†åƒç´ æ“ä½œï¼Œæ¸›å°‘å¾ªç’°é–‹éŠ·
- **å¿«é€Ÿæ¢¯åº¦**: ä½¿ç”¨Scharrç®—å­æ›¿ä»£Sobelï¼Œæå‡ç²¾åº¦å’Œé€Ÿåº¦
- **LRUç·©å­˜**: ç·©å­˜å¸¸ç”¨è¨ˆç®—çµæœï¼Œé¿å…é‡è¤‡è¨ˆç®—

### ğŸ”§ è‡ªé©æ‡‰é…ç½®
- **å‹•æ…‹æ‰¹æ¬¡å¤§å°**: æ ¹æ“šå¯ç”¨GPUè¨˜æ†¶é«”è‡ªå‹•èª¿æ•´æ‰¹æ¬¡å¤§å°
- **ç¡¬é«”æª¢æ¸¬**: è‡ªå‹•æª¢æ¸¬ç¡¬é«”é…ç½®ä¸¦æ‡‰ç”¨æœ€ä½³è¨­å®š
- **æ€§èƒ½é…ç½®æª”æ¡ˆ**: æä¾›å¤šç¨®é è¨­é…ç½®é©æ‡‰ä¸åŒéœ€æ±‚

## é æœŸæ€§èƒ½æå‡

æ ¹æ“šç¡¬é«”é…ç½®ä¸åŒï¼Œå„ªåŒ–ç‰ˆæœ¬é è¨ˆå¯å¯¦ç¾ï¼š

- **è™•ç†é€Ÿåº¦**: 2-5å€æå‡
- **è¨˜æ†¶é«”ä½¿ç”¨**: é™ä½20-40%
- **GPUåˆ©ç”¨ç‡**: æå‡30-60%
- **ç¸½é«”æ•ˆç‡**: 3-8å€æå‡

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```bash
# ä½¿ç”¨å„ªåŒ–ç‰ˆæœ¬ (æ¨è–¦)
python3 taipei101_denoise_optimized.py \
    --input_dir testsets/taipei101 \
    --output_dir taipei101_denoised_opt \
    --batch_size 4

# ä½¿ç”¨åŸç‰ˆæœ¬ (å°æ¯”)
python3 taipei101_denoise.py \
    --input_dir testsets/taipei101 \
    --output_dir taipei101_denoised_orig
```

### é«˜ç´šåƒæ•¸

```bash
python3 taipei101_denoise_optimized.py \
    --input_dir testsets/taipei101 \
    --output_dir taipei101_denoised_opt \
    --batch_size 8 \
    --use_amp \
    --enable_detail_enhancement \
    --enable_frequency_preservation \
    --num_workers 4
```

### æ€§èƒ½é…ç½®æª”æ¡ˆ

```python
# ä½¿ç”¨é…ç½®æ–‡ä»¶ç²å–æœ€ä½³è¨­å®š
from optimization_config import get_optimal_config, apply_performance_profile

# ç²å–ç¡¬é«”æœ€ä½³é…ç½®
config = get_optimal_config()

# æ‡‰ç”¨ç‰¹å®šæ€§èƒ½é…ç½®æª”æ¡ˆ
config = apply_performance_profile(config, 'ultra_fast')  # æœ€å¿«é€Ÿåº¦
config = apply_performance_profile(config, 'balanced')    # å¹³è¡¡æ¨¡å¼
config = apply_performance_profile(config, 'high_quality') # é«˜è³ªé‡
config = apply_performance_profile(config, 'memory_efficient') # ç¯€ç´„è¨˜æ†¶é«”
```

## æ€§èƒ½åŸºæº–æ¸¬è©¦

### é‹è¡ŒåŸºæº–æ¸¬è©¦

```bash
# æ¯”è¼ƒåŸç‰ˆæœ¬å’Œå„ªåŒ–ç‰ˆæœ¬æ€§èƒ½
python3 benchmark_performance.py \
    --input_dir testsets/taipei101 \
    --num_test_images 10 \
    --batch_sizes "1,2,4,8"
```

### æŸ¥çœ‹ç³»çµ±é…ç½®å»ºè­°

```bash
# ç²å–ç¡¬é«”ä¿¡æ¯å’Œæœ€ä½³åŒ–å»ºè­°
python3 optimization_config.py
```

## å‘½ä»¤è¡Œåƒæ•¸èªªæ˜

### taipei101_denoise_optimized.py

| åƒæ•¸ | é è¨­å€¼ | èªªæ˜ |
|------|--------|------|
| `--input_dir` | `testsets/taipei101` | è¼¸å…¥å½±åƒç›®éŒ„ |
| `--output_dir` | `taipei101_color_denoised_opt` | è¼¸å‡ºçµæœç›®éŒ„ |
| `--batch_size` | `4` | æ‰¹è™•ç†å¤§å° |
| `--noise_level` | `10.0` | é›œè¨Šç­‰ç´š (0-255) |
| `--device` | `auto` | é‹ç®—è¨­å‚™ (auto/cpu/cuda) |
| `--use_amp` | `True` | ä½¿ç”¨æ··åˆç²¾åº¦åŠ é€Ÿ |
| `--enable_detail_enhancement` | `True` | å•Ÿç”¨ç´°ç¯€å¢å¼· |
| `--enable_frequency_preservation` | `True` | å•Ÿç”¨é »åŸŸç´°ç¯€ä¿è­· |
| `--num_workers` | `4` | ä¸¦è¡Œè™•ç†ç·šç¨‹æ•¸ |

### benchmark_performance.py

| åƒæ•¸ | é è¨­å€¼ | èªªæ˜ |
|------|--------|------|
| `--input_dir` | å¿…éœ€ | æ¸¬è©¦åœ–åƒç›®éŒ„ |
| `--num_test_images` | `5` | æ¸¬è©¦åœ–åƒæ•¸é‡ |
| `--batch_sizes` | `"1,2,4"` | æ¸¬è©¦æ‰¹æ¬¡å¤§å°åˆ—è¡¨ |
| `--output_base_dir` | `benchmark_results` | æ¸¬è©¦çµæœç›®éŒ„ |

## ç¡¬é«”å»ºè­°

### GPUé…ç½®
- **é«˜ç«¯GPU (8GB+)**: æ‰¹æ¬¡å¤§å°8-16ï¼Œå•Ÿç”¨æ··åˆç²¾åº¦
- **ä¸­ç«¯GPU (4-8GB)**: æ‰¹æ¬¡å¤§å°4-8ï¼Œå•Ÿç”¨æ··åˆç²¾åº¦
- **ä½ç«¯GPU (<4GB)**: æ‰¹æ¬¡å¤§å°2-4ï¼Œè€ƒæ…®è¨˜æ†¶é«”ç¯€ç´„æ¨¡å¼

### CPUé…ç½®
- **é«˜ç«¯CPU (8æ ¸+)**: æ‰¹æ¬¡å¤§å°4-8ï¼Œå¤šç·šç¨‹I/O
- **ä¸­ç«¯CPU (4-8æ ¸)**: æ‰¹æ¬¡å¤§å°2-4ï¼Œé©åº¦ä¸¦è¡Œ
- **ä½ç«¯CPU (<4æ ¸)**: æ‰¹æ¬¡å¤§å°1-2ï¼ŒåŸºæœ¬é…ç½®

## æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **GPUè¨˜æ†¶é«”ä¸è¶³ (OOM)**
   ```bash
   # æ¸›å°‘æ‰¹æ¬¡å¤§å°
   --batch_size 2
   
   # ä½¿ç”¨è¨˜æ†¶é«”ç¯€ç´„æ¨¡å¼
   python3 -c "from optimization_config import apply_performance_profile, get_optimal_config; print(apply_performance_profile(get_optimal_config(), 'memory_efficient'))"
   ```

2. **è™•ç†é€Ÿåº¦æ…¢**
   ```bash
   # æª¢æŸ¥æ˜¯å¦å•Ÿç”¨GPU
   --device cuda
   
   # å¢åŠ æ‰¹æ¬¡å¤§å°
   --batch_size 8
   
   # å•Ÿç”¨æ··åˆç²¾åº¦
   --use_amp
   ```

3. **å½±åƒè³ªé‡å•é¡Œ**
   ```bash
   # å•Ÿç”¨æ‰€æœ‰å¾Œè™•ç†
   --enable_detail_enhancement --enable_frequency_preservation
   
   # ä½¿ç”¨é«˜è³ªé‡æ¨¡å¼
   python3 -c "from optimization_config import apply_performance_profile, get_optimal_config; print(apply_performance_profile(get_optimal_config(), 'high_quality'))"
   ```

### ç’°å¢ƒè®Šæ•¸å„ªåŒ–

```bash
# GPUè¨˜æ†¶é«”åˆ†é…å„ªåŒ–
export PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:128

# æŒ‡å®šGPUè¨­å‚™
export CUDA_VISIBLE_DEVICES=0

# å•Ÿç”¨cudNNåŸºæº–æ¸¬è©¦
export TORCH_CUDNN_BENCHMARK=1
```

## æ–‡ä»¶èªªæ˜

- `taipei101_denoise_optimized.py`: å„ªåŒ–ç‰ˆæœ¬ä¸»è…³æœ¬
- `optimization_config.py`: ç¡¬é«”é…ç½®å’Œæ€§èƒ½è¨­å®š
- `benchmark_performance.py`: æ€§èƒ½åŸºæº–æ¸¬è©¦å·¥å…·
- `taipei101_denoise.py`: åŸç‰ˆæœ¬ (ç”¨æ–¼æ¯”è¼ƒ)

## æŠ€è¡“ç´°ç¯€

### æ‰¹é‡è™•ç†æµç¨‹
1. ä¸¦è¡Œè¼‰å…¥å¤šå¼µå½±åƒ
2. çµ±ä¸€å°ºå¯¸ä¸¦è½‰æ›ç‚ºbatch tensor
3. æ‰¹é‡æ¨¡å‹æ¨ç†
4. æ‰¹é‡å¾Œè™•ç†
5. ä¸¦è¡Œä¿å­˜çµæœ

### è¨˜æ†¶é«”å„ªåŒ–ç­–ç•¥
1. é åˆ†é…tensorè¨˜æ†¶é«”
2. åŠæ™‚é‡‹æ”¾ä¸­é–“è®Šé‡
3. GPUè¨˜æ†¶é«”åƒåœ¾å›æ”¶
4. å‹•æ…‹æ‰¹æ¬¡å¤§å°èª¿æ•´

### è¨ˆç®—å„ªåŒ–æŠ€è¡“
1. å¯åˆ†é›¢å·ç©æ¿¾æ³¢å™¨
2. å‘é‡åŒ–åƒç´ æ“ä½œ
3. LRUç·©å­˜æ©Ÿåˆ¶
4. JITç·¨è­¯å„ªåŒ–

## ç‰ˆæœ¬å°æ¯”

| ç‰¹æ€§ | åŸç‰ˆæœ¬ | å„ªåŒ–ç‰ˆæœ¬ |
|------|--------|----------|
| æ‰¹é‡è™•ç† | âŒ | âœ… |
| æ··åˆç²¾åº¦ | âŒ | âœ… |
| ä¸¦è¡ŒI/O | âŒ | âœ… |
| è¨˜æ†¶é«”å„ªåŒ– | âŒ | âœ… |
| è‡ªé©æ‡‰é…ç½® | âŒ | âœ… |
| æ€§èƒ½ç›£æ§ | âŒ | âœ… |
| è™•ç†é€Ÿåº¦ | 1x | 2-5x |
| è¨˜æ†¶é«”ä½¿ç”¨ | 100% | 60-80% |

## è²¢ç»å’Œåé¥‹

å¦‚æœæ‚¨åœ¨ä½¿ç”¨éç¨‹ä¸­é‡åˆ°å•é¡Œæˆ–æœ‰æ”¹é€²å»ºè­°ï¼Œæ­¡è¿åé¥‹ï¼š

1. ä½¿ç”¨åŸºæº–æ¸¬è©¦å·¥å…·æ¸¬è©¦æ€§èƒ½
2. æŸ¥çœ‹ç”Ÿæˆçš„HTMLæ€§èƒ½å ±å‘Š
3. æ ¹æ“šç¡¬é«”é…ç½®èª¿æ•´åƒæ•¸
4. å˜—è©¦ä¸åŒçš„æ€§èƒ½é…ç½®æª”æ¡ˆ

---

**æ³¨æ„**: å„ªåŒ–ç‰ˆæœ¬ä¿æŒäº†èˆ‡åŸç‰ˆæœ¬ç›¸åŒçš„å»å™ªæ•ˆæœï¼Œåªæ˜¯å¤§å¹…æå‡äº†è™•ç†æ•ˆç‡ã€‚å»ºè­°å…ˆä½¿ç”¨åŸºæº–æ¸¬è©¦å·¥å…·æ¯”è¼ƒå…©å€‹ç‰ˆæœ¬çš„æ€§èƒ½å·®ç•°ã€‚